name: Build and Release APK

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Build APK
        working-directory: ./android-app
        run: |
          chmod +x gradlew
          ./gradlew clean assembleDebug

      - name: Get APK info
        id: apk_info
        run: |
          echo "APK_PATH=$(find ./android-app -name 'app-debug.apk' -type f | head -1)" >> $GITHUB_OUTPUT
          echo "APK_NAME=wifi-failover-$(date +%Y%m%d-%H%M%S).apk" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ${{ steps.apk_info.outputs.APK_PATH }}
          body: |
            ## WiFi Failover Utility - Android App Release

            ### Installation
            1. Download the APK file below
            2. Enable "Install from Unknown Sources" on your Android device
            3. Transfer the APK to your phone and tap to install
            4. Or: `adb install wifi-failover-*.apk`

            ### Setup
            1. Tap "Enable Device Admin" in the app
            2. Enter your Worker URL and Secret
            3. Enter your phone's hotspot SSID
            4. Tap "Start Monitoring"

            The app will now monitor your Mac daemon in the background and automatically enable hotspot when the daemon goes offline.

            ### Requirements
            - Android 11+ (API 30+)
            - Device Admin permission
            - Accessibility Service enabled (for automatic hotspot toggle)

            ### Features
            - Automatic daemon status polling
            - Automatic hotspot enablement on Mac WiFi failure
            - WorkManager-based background operation
            - No need to keep app open
            - Debug logging for troubleshooting
          draft: false
          prerelease: false

      - name: Upload APK as Artifact
        uses: actions/upload-artifact@v3
        with:
          name: wifi-failover-apk
          path: ${{ steps.apk_info.outputs.APK_PATH }}
          retention-days: 30
